<!DOCTYPE html>
<html>

<head>
    <title>Data Visualization</title>
    <script src="./js/d3.min.js"></script>
</head>

<body>

    <svg width="1920" height="1080" id="mainSvg" class="svgs"></svg>

    <script>
        const mainSvg = d3.select('.svgs')
        const mainWidth = +mainSvg.attr("width");
        const mainHeight = +mainSvg.attr("height");
        const margin = {
            top: 60,
            right: 120,
            bottom: 120,
            left: 60
        };
        const innerWidth = mainWidth - margin.left - margin.right;
        const innerHeight = mainHeight - margin.bottom - margin.top;

        //图表部分的尺寸
        const width = innerWidth;
        const height = innerHeight;

        const g = mainSvg.append("g")
            .attr("id", "mainGroup")
            .attr("width", width)
            .attr("height", height)
            .attr("transform", `translate(${margin.left}, ${margin.top})`);


        d3.csv("./data/box_office.csv").then(data => {
            
            //处理数据
            data.forEach(e => {
                
                e["日期"] = getDate(e["日期"]);
                e["排名"] = +e["排名"];
                e["单日票房(万)"] = +(e["单日票房(万)"].replace(",", ""));
                e["累计票房(万)"] = +(e["累计票房(万)"].replace(",", ""));
            });
            console.log(data);

            //按日期把数据归类
            //Set中元素不重复，用以获得日期列表
            var map = data.map(d => d["日期"].toString());
            var set = new Set(map);
            dates = Array.from(set);
            console.log(dates);
            //日期排序
            dates.sort((a, b) => Date(a) - Date(b));
            

            //给日期安排数组空间
            var seqList = []; //应当是二维数组
            dates.forEach(date => {
                seqList.push([]);
            });
            

            //把各个日期数据放入空间
            data.forEach(d => {
                seqList[dates.indexOf(d["日期"].toString())].push(d);
            });
            console.log(seqList);

            
            initAxis(data);
            
        });

        // 输入“2020年12月1日”格式的字符串
        // 返回一个Date对象
        const getDate = function(date){
            var yearIndex = date.indexOf("年");
            var monthIndex = date.indexOf("月");
            var dayIndex = date.indexOf("日");

            var year = +(date.substring(0, yearIndex));
            var month = +(date.substring(yearIndex+1, monthIndex));
            var day = +(date.substring(monthIndex+1, dayIndex));

            return new Date(year, month, day);

        }

        var xScale, yScale;
        
        const initAxis = function (data) {

            var arr = new Array(10);
            for(var i=0; i < 10; i++){
                arr[i] = i+1;
            }

            yScale = d3.scaleBand()
                .domain(arr)
                .range([0, innerHeight])
                .padding(0.5)

            xScale = d3.scaleLinear()
                .domain( d3.extent(data, e=>e["累计票房(万)"]) )
                .range([0, innerWidth]);

            var xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight);
            
            var yAxis = d3.axisLeft(yScale)
                .tickSize(-innerWidth);

            var xAxisGroup = g.append("g").call(xAxis)
                .attr("transform", `translate(0, ${innerHeight})`);
            var yAxisGroup = g.append("g").call(yAxis);
        }

        const update = function (data) {
            
        }







    </script>
</body>

</html>